# ed-news

## Overview

This repository is a small static site generator and feed builder written in Python. It produces an `index.html` and an RSS feed from a collection of feeds and metadata. The project is organized as a package named `ednews` and a set of top-level scripts used to build and publish the site.

Most of this project was vibecoded with GitHub Copilot using GPT-5 mini.

## Current project layout

Top-level files and directories (important ones):

```
.
├── build.py                # Convenience build script (top-level)
├── main.py                 # CLI entry for building/serving
├── fetch.py                # Fetch helper script
├── calculate_vectors.py    # Utility for embedding/vector calculations
├── planet.json             # Sample site metadata
├── pyproject.toml          # Poetry/packaging config
├── ednews/                 # Main package
│   ├── __init__.py
│   ├── build.py            # core build logic used by scripts/tests
│   ├── config.py           # configuration helpers
│   ├── crossref.py         # CrossRef integration
│   ├── db.py               # simple DB helpers
│   ├── embeddings.py       # vector/embedding utilities
│   ├── feeds.py            # feed fetching/normalization
│   ├── sciencedirect.py    # ScienceDirect integration
│   └── ...
├── templates/              # Jinja2 templates used by the build
│   ├── index.html.jinja2
│   └── index.rss.jinja2
├── static/                 # Static assets included in the build
│   ├── main.css
│   └── main.js
├── build/                  # Output directory (generated by build)
│   └── ...
└── tests/                  # Test suite
    ├── test_build.py
    ├── test_crossref.py
    ├── test_crossref_integration.py
    ├── test_db_and_embeddings.py
    ├── test_doi_helpers.py
    └── test_feeds.py
    └── ...
```

Files in `ednews` correspond to small modules that the tests exercise. The top-level scripts (`build.py`, `main.py`, `fetch.py`) call into the package code.

## Setup

Create a virtual environment and activate it using `uv`:

```bash
uv sync
```

## Build and run

To generate the site output into the `build/` directory run the top-level build script:

```bash
uv run python build.py
```

You can also use the unified CLI entrypoint in `main.py`, which exposes several useful subcommands. Examples:

```bash
# Fetch feeds and save entries to the local DB
uv run python main.py fetch

# Render the static site (same as running build.py)
uv run python main.py build --out-dir build

# Generate embeddings and store them in the DB (optional model and batch size)
uv run python main.py embed --model <model-name> --batch-size 64

# Enrich articles by querying Crossref for missing metadata
uv run python main.py enrich-crossref --batch-size 20 --delay 0.1

# Lookup recent works for journals by ISSN and insert into DB
uv run python main.py issn-lookup --per-journal 30 --timeout 10 --delay 0.05
```

Tip: most `main.py` commands accept a global `-v/--verbose` flag to enable debug logging. Example:

```bash
# Run fetch with verbose logging
uv run python main.py -v fetch
```

Examples for the new fetch flags:

```bash
# Fetch both article feeds and news headlines (default)
uv run python main.py fetch

# Fetch only article feeds
uv run python main.py fetch --articles

# Fetch only news headlines
uv run python main.py fetch --headlines

# Explicitly fetch both
uv run python main.py fetch --articles --headlines
```

There is also `ednews.build` which contains the core build logic and is exercised by tests. `main.py` provides a convenient CLI wrapper that calls into the package code.

The generated output will be placed in `build/` and includes `index.html`, `index.rss`, and a `static/` folder with assets.

## Tests

Run the test suite with pytest:

```bash
uv run pytest -q
```

Tests live in the `tests/` directory and include unit and integration tests for CrossRef, feeds, DB and embeddings helpers.

### CrossRef Tests

Enable CrossRef integration tests by setting the RUN_CROSSREF_INTEGRATION environment variable, then run the full test suite.

```bash
# persistent in current shell
export RUN_CROSSREF_INTEGRATION=1
uv run pytest -q

# or as a one-liner
RUN_CROSSREF_INTEGRATION=1 uv run pytest -q
```

## Contributing

Contributions welcome. Run tests before submitting PRs and follow the existing code style. If you add external integrations, include mocks or fixtures in `tests/fixtures` to keep test runs fast and hermetic.

## Changes

    When more than the configured number of articles share the same published DATE as the Nth
    most recent article, all articles for that date are included so a day's publications are
    not arbitrarily truncated.

    The default is configurable in code at `ednews.config.ARTICLES_DEFAULT_LIMIT`.

- Filtering: feed items that are entirely empty (no title, no link, and no content/summary)
    are now filtered out at build time and before persisting into the database. This prevents
    empty/placeholder entries from appearing in generated RSS feeds or being stored in the
    `items` table. The behavior is implemented in `ednews.build.item_has_content` and
    `ednews.feeds.entry_has_content` and is covered by unit tests under `tests/`.

## Developer notes: DB refactor (import path change)

The database management helpers were reorganized into a `db` subpackage to
group related functionality. The management helpers that used to be
available as `ednews.manage_db` are now located at `ednews.db.manage_db`.

What changed:
- Old import: `from ednews import manage_db` or `import ednews.manage_db`
- New import: `from ednews.db import manage_db` or `import ednews.db.manage_db`

Tests and the package have been updated to use the new path. If you have
external code that imports `ednews.manage_db`, update it to the new path.

Quick codemod suggestion (run from repo root) to update external imports on macOS / BSD `sed`:

```bash
# Replace `from ednews import manage_db` with `from ednews.db import manage_db`
grep -Rl "from ednews import manage_db" | xargs -r sed -i '' "s|from ednews import manage_db|from ednews.db import manage_db|g"

# Replace `import ednews.manage_db` with `import ednews.db.manage_db`
grep -Rl "import ednews.manage_db" | xargs -r sed -i '' "s|import ednews.manage_db|import ednews.db.manage_db|g"
```

If you prefer a transition shim (keeps `from ednews import manage_db` working
but emits a DeprecationWarning), tell me and I will add a small `ednews/manage_db.py`
shim that imports from `ednews.db.manage_db` and warns users.